/* luhn.c -- luhn verification routine, based on a
 * left to right Deterministic Finite Automaton.
 * Author: Luis Colorado <luiscoloradourcola@gmail.com>
 * Date: Sun Oct 23 06:33:17 AM EEST 2022
 * Copyright: (2) 2022 Luis Colorado.  All rights reserved.
 * License: BSD.
 */
#include <ctype.h>
#include <stdio.h>
#include <string.h>

#define RES_OK   " OK"
#define RES_BAD  " BAD"

/* the following table is 1Kb large, so it is worth
 * implementing it as such and not worry about its
 * size.  Automaton has 100 states (0..99) and it
 * stores the next state based on the read character.
 * The accepting states are the first ten states. */
const static char luhn_tab[][10] = {

    /* ACCEPTING STATES */
    {  0, 98, 86, 74, 62, 59, 47, 35, 23, 11 },
    { 10,  8, 96, 84, 72, 69, 57, 45, 33, 21 },
    { 20, 18,  6, 94, 82, 79, 67, 55, 43, 31 },
    { 30, 28, 16,  4, 92, 89, 77, 65, 53, 41 },
    { 40, 38, 26, 14,  2, 99, 87, 75, 63, 51 },
    { 50, 48, 36, 24, 12,  9, 97, 85, 73, 61 },
    { 60, 58, 46, 34, 22, 19,  7, 95, 83, 71 },
    { 70, 68, 56, 44, 32, 29, 17,  5, 93, 81 },
    { 80, 78, 66, 54, 42, 39, 27, 15,  3, 91 },
    { 90, 88, 76, 64, 52, 49, 37, 25, 13,  1 },

    /* no more accepting below this point */
    {  1, 99, 87, 75, 63, 50, 48, 36, 24, 12 },
    { 11,  9, 97, 85, 73, 60, 58, 46, 34, 22 },
    { 21, 19,  7, 95, 83, 70, 68, 56, 44, 32 },
    { 31, 29, 17,  5, 93, 80, 78, 66, 54, 42 },
    { 41, 39, 27, 15,  3, 90, 88, 76, 64, 52 },
    { 51, 49, 37, 25, 13,  0, 98, 86, 74, 62 }, 
    { 61, 59, 47, 35, 23, 10,  8, 96, 84, 72 },
    { 71, 69, 57, 45, 33, 20, 18,  6, 94, 82 },
    { 81, 79, 67, 55, 43, 30, 28, 16,  4, 92 },
    { 91, 89, 77, 65, 53, 40, 38, 26, 14,  2 }, 

    {  2, 90, 88, 76, 64, 51, 49, 37, 25, 13 }, 
    { 12,  0, 98, 86, 74, 61, 59, 47, 35, 23 }, 
    { 22, 10,  8, 96, 84, 71, 69, 57, 45, 33 },
    { 32, 20, 18,  6, 94, 81, 79, 67, 55, 43 },
    { 42, 30, 28, 16,  4, 91, 89, 77, 65, 53 },
    { 52, 40, 38, 26, 14,  1, 99, 87, 75, 63 }, 
    { 62, 50, 48, 36, 24, 11,  9, 97, 85, 73 },
    { 72, 60, 58, 46, 34, 21, 19,  7, 95, 83 },
    { 82, 70, 68, 56, 44, 31, 29, 17,  5, 93 },
    { 92, 80, 78, 66, 54, 41, 39, 27, 15,  3 }, 

    {  3, 91, 89, 77, 65, 52, 40, 38, 26, 14 }, 
    { 13,  1, 99, 87, 75, 62, 50, 48, 36, 24 }, 
    { 23, 11,  9, 97, 85, 72, 60, 58, 46, 34 },
    { 33, 21, 19,  7, 95, 82, 70, 68, 56, 44 },
    { 43, 31, 29, 17,  5, 92, 80, 78, 66, 54 },
    { 53, 41, 39, 27, 15,  2, 90, 88, 76, 64 }, 
    { 63, 51, 49, 37, 25, 12,  0, 98, 86, 74 },
    { 73, 61, 59, 47, 35, 22, 10,  8, 96, 84 },
    { 83, 71, 69, 57, 45, 32, 20, 18,  6, 94 },
    { 93, 81, 79, 67, 55, 42, 30, 28, 16,  4 }, 

    {  4, 92, 80, 78, 66, 53, 41, 39, 27, 15 }, 
    { 14,  2, 90, 88, 76, 63, 51, 49, 37, 25 }, 
    { 24, 12,  0, 98, 86, 73, 61, 59, 47, 35 },
    { 34, 22, 10,  8, 96, 83, 71, 69, 57, 45 },
    { 44, 32, 20, 18,  6, 93, 81, 79, 67, 55 },
    { 54, 42, 30, 28, 16,  3, 91, 89, 77, 65 }, 
    { 64, 52, 40, 38, 26, 13,  1, 99, 87, 75 },
    { 74, 62, 50, 48, 36, 23, 11,  9, 97, 85 },
    { 84, 72, 60, 58, 46, 33, 21, 19,  7, 95 },
    { 94, 82, 70, 68, 56, 43, 31, 29, 17,  5 }, 

    {  5, 93, 81, 79, 67, 54, 42, 30, 28, 16 }, 
    { 15,  3, 91, 89, 77, 64, 52, 40, 38, 26 }, 
    { 25, 13,  1, 99, 87, 74, 62, 50, 48, 36 },
    { 35, 23, 11,  9, 97, 84, 72, 60, 58, 46 },
    { 45, 33, 21, 19,  7, 94, 82, 70, 68, 56 },
    { 55, 43, 31, 29, 17,  4, 92, 80, 78, 66 }, 
    { 65, 53, 41, 39, 27, 14,  2, 90, 88, 76 },
    { 75, 63, 51, 49, 37, 24, 12,  0, 98, 86 },
    { 85, 73, 61, 59, 47, 34, 22, 10,  8, 96 },
    { 95, 83, 71, 69, 57, 44, 32, 20, 18,  6 }, 

    {  6, 94, 82, 70, 68, 55, 43, 31, 29, 17 }, 
    { 16,  4, 92, 80, 78, 65, 53, 41, 39, 27 }, 
    { 26, 14,  2, 90, 88, 75, 63, 51, 49, 37 },
    { 36, 24, 12,  0, 98, 85, 73, 61, 59, 47 },
    { 46, 34, 22, 10,  8, 95, 83, 71, 69, 57 },
    { 56, 44, 32, 20, 18,  5, 93, 81, 79, 67 }, 
    { 66, 54, 42, 30, 28, 15,  3, 91, 89, 77 },
    { 76, 64, 52, 40, 38, 25, 13,  1, 99, 87 },
    { 86, 74, 62, 50, 48, 35, 23, 11,  9, 97 },
    { 96, 84, 72, 60, 58, 45, 33, 21, 19,  7 }, 

    {  7, 95, 83, 71, 69, 56, 44, 32, 20, 18 }, 
    { 17,  5, 93, 81, 79, 66, 54, 42, 30, 28 }, 
    { 27, 15,  3, 91, 89, 76, 64, 52, 40, 38 },
    { 37, 25, 13,  1, 99, 86, 74, 62, 50, 48 },
    { 47, 35, 23, 11,  9, 96, 84, 72, 60, 58 },
    { 57, 45, 33, 21, 19,  6, 94, 82, 70, 68 }, 
    { 67, 55, 43, 31, 29, 16,  4, 92, 80, 78 },
    { 77, 65, 53, 41, 39, 26, 14,  2, 90, 88 },
    { 87, 75, 63, 51, 49, 36, 24, 12,  0, 98 },
    { 97, 85, 73, 61, 59, 46, 34, 22, 10,  8 }, 

    {  8, 96, 84, 72, 60, 57, 45, 33, 21, 19 }, 
    { 18,  6, 94, 82, 70, 67, 55, 43, 31, 29 }, 
    { 28, 16,  4, 92, 80, 77, 65, 53, 41, 39 },
    { 38, 26, 14,  2, 90, 87, 75, 63, 51, 49 },
    { 48, 36, 24, 12,  0, 97, 85, 73, 61, 59 },
    { 58, 46, 34, 22, 10,  7, 95, 83, 71, 69 }, 
    { 68, 56, 44, 32, 20, 17,  5, 93, 81, 79 },
    { 78, 66, 54, 42, 30, 27, 15,  3, 91, 89 },
    { 88, 76, 64, 52, 40, 37, 25, 13,  1, 99 },
    { 98, 86, 74, 62, 50, 47, 35, 23, 11,  9 }, 

    {  9, 97, 85, 73, 61, 58, 46, 34, 22, 10 }, 
    { 19,  7, 95, 83, 71, 68, 56, 44, 32, 20 }, 
    { 29, 17,  5, 93, 81, 78, 66, 54, 42, 30 },
    { 39, 27, 15,  3, 91, 88, 76, 64, 52, 40 },
    { 49, 37, 25, 13,  1, 98, 86, 74, 62, 50 },
    { 59, 47, 35, 23, 11,  8, 96, 84, 72, 60 }, 
    { 69, 57, 45, 33, 21, 18,  6, 94, 82, 70 },
    { 79, 67, 55, 43, 31, 28, 16,  4, 92, 80 },
    { 89, 77, 65, 53, 41, 38, 26, 14,  2, 90 },
    { 99, 87, 75, 63, 51, 48, 36, 24, 12,  0 }, 
}; /* luhn_tab */

int luhn_ok(char *s)
{
    char st = 0, /* automaton state, initially zero */
         c; /* read char */

    while ((c = *s++) != '\0'
            && (isspace(c) || isdigit(c)))
    {
        if (isdigit(c))
            st = luhn_tab[st][c - '0'];
    }

    return st < 10;
} /* luhn_ok */

int main(int argc, char **argv)
{
    if (argc > 1) for (int i = 1; i < argc; i++) {
        printf("%s%s\n",
                argv[i],
                luhn_ok(argv[i])
                    ? RES_OK
                    : RES_BAD);
    } else {
        char buffer[1024];
        while (fgets(buffer, sizeof buffer, stdin)) {
            strtok(buffer, "\n");
            printf("%s%s\n",
                    buffer,
                    luhn_ok(buffer)
                        ? RES_OK
                        : RES_BAD);
        }
    }
} /* main */
